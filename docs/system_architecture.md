# システムアーキテクチャ設計書

本ドキュメントは、プロジェクト「キメラの卵」の技術スタック、システム構成、および各コンポーネント間の連携について定義する。

## 1. システム構成図

```
+----------------------+      +-------------------------+      +----------------------+ 
|      作業員          |      |      LINE App           |      |   AppSheet / n8n     |
| (スマートフォン)     |      | (Messaging API)         |      | (既存の機材管理DB)   |
+----------------------+      +-------------------------+      +----------------------+ 
         |                            | (Webhook)                    | (API / Webhook)
         | (HTTPS)                    |                              |
         v                            v                              v
+-----------------------------------------------------------------------------------+
|                                                                                   |
|                            キメラの卵 アプリケーション (本プロジェクト)           |
|                                                                                   |
|  +-------------------------+      +-------------------------+      +------------+ |
|  |     フロントエンド      |      |       バックエンド        |      | データベース | |
|  |      (React/Next.js)    |<---->|      (Node.js/Express)    |<---->| (PostgreSQL)| |
|  +-------------------------+      +-------------------------+      +------------+ |
|                                                                                   |
+-----------------------------------------------------------------------------------+
```

## 2. 技術スタック

### 2.1. フロントエンド

*   **フレームワーク:** **React (Next.js)**
    *   **理由:**
        *   コンポーネントベースの開発により、UIの再利用性とメンテナンス性が向上する。
        *   豊富なUIライブラリ（MUI, Chakra UIなど）を活用でき、高品質なUIを迅速に構築可能。
        *   サーバーサイドレンダリング（SSR）や静的サイト生成（SSG）に対応しており、パフォーマンスが良い。
        *   `context_engineering(禁煙アプリ用）`での開発実績があり、知見を活かせる。
*   **言語:** **TypeScript**
    *   **理由:** 静的型付けにより、開発時のエラーを早期に検知し、コードの堅牢性を高める。

### 2.2. バックエンド

*   **フレームワーク:** **Node.js (Express)**
    *   **理由:**
        *   フロントエンドと同一言語（JavaScript/TypeScript）で開発でき、チーム全体の開発効率が良い。
        *   軽量でありながら、ミドルウェアの組み合わせにより柔軟に拡張可能。
        *   n8nやDifyなど、外部サービスとのAPI連携（REST API）の実装が容易。
*   **言語:** **TypeScript**
*   **ORM:** **Prisma**
    *   **理由:**
        *   直感的なスキーマ定義ファイルから型安全なデータベースクライアントを自動生成できる。
        *   `context_engineering(禁煙アプリ用）`での開発実績がある。

### 2.3. データベース

*   **RDBMS:** **PostgreSQL**
    *   **理由:**
        *   オープンソースでありながら、信頼性、堅牢性、拡張性に優れる。
        *   JSONB型などの高度なデータ型をサポートしており、将来的な機能拡張にも柔軟に対応可能。

## 3. 既存システムとの連携

### 3.1. AppSheet / n8n (機材データソース)

*   **連携方法:**
    1.  **定期的なデータ同期（推奨）:**
        *   n8nのワークフロー、またはバックエンドで実装したバッチ処理が、定期的（例: 1時間に1回）にAppSheetのAPIを呼び出し、機材のマスターデータやメンテナンス状況を取得する。
        *   取得したデータを本システムのPostgreSQLデータベースに同期する。
        *   **メリット:** AppSheet側のAPI負荷を軽減でき、本アプリのレスポンスが高速になる。
    2.  **リアルタイム連携:**
        *   AppSheet側でデータが更新された際にWebhookを発行し、本システムのバックエンドがそれを受け取ってリアルタイムにDBを更新する。
        *   **課題:** AppSheetのWebhook機能の制約や、リアルタイム性の要件を精査する必要がある。

*   **初期実装:** まずは **定期的なデータ同期** で実装を進める。

### 3.2. LINE (通知機能)

*   **連携方法:** LINE Messaging APIを利用する。
*   **ユースケース:**
    *   機材の状態が「病気」になってから一定時間経過しても放置されている場合に、担当作業員へメンション付きで通知する。
    *   「チームミッション」の開始や達成を通知する。
*   **実装:** バックエンドからLINE Messaging APIのエンドポイントを呼び出し、プッシュメッセージを送信する。ユーザーのLINE IDとアプリのユーザーIDを紐付けておく必要がある。

### 3.3. Dify

*   **連携方法:** 現時点では直接の連携は想定しない。
*   **将来的な展望:**
    *   機材のメンテナンス方法に関する質問に自動で回答するチャットボット機能。
    *   Difyで作成したAIエージェントを、バックエンドからAPI経由で呼び出す形で連携する可能性がある。

## 4. 開発・インフラ環境

*   **ソースコード管理:** Git / GitHub
*   **インフラ:** 未定（今後の検討課題。Vercel, AWS, Google Cloudなどが候補）
*   **CI/CD:** GitHub Actions
